{% extends 'provisao/base.html' %}

{% block title %}Tabela de Provisão{% endblock %}

{% block content %}

<!-- ═══════════════════════════════════════════════════
     STAT CARDS
     ═══════════════════════════════════════════════════ -->
<div class="row g-3 mb-4">

    <div class="col-6 col-md-3 animate-up">
        <div class="rennova-card stat-card total h-100 mb-0">
            <div class="rennova-card-body py-3">
                <div class="stat-label">Total colaboradores</div>
                <div class="stat-number text-primary">{{ total }}</div>
            </div>
        </div>
    </div>

    <div class="col-6 col-md-3 animate-up">
        <div class="rennova-card stat-card danger h-100 mb-0">
            <div class="rennova-card-body py-3">
                <div class="stat-label">⚠ Urgente</div>
                <div class="stat-number text-danger">{{ urgentes }}</div>
            </div>
        </div>
    </div>

    <div class="col-6 col-md-3 animate-up">
        <div class="rennova-card stat-card warning h-100 mb-0">
            <div class="rennova-card-body py-3">
                <div class="stat-label">⏰ Atenção</div>
                <div class="stat-number" style="color:var(--warning-color);">{{ atencao }}</div>
            </div>
        </div>
    </div>

    <div class="col-6 col-md-3 animate-up">
        <div class="rennova-card stat-card info h-100 mb-0">
            <div class="rennova-card-body py-3">
                <div class="stat-label">Última importação</div>
                <div class="fw-600" style="font-size:0.85rem;color:var(--info-color);">
                    {% if ultima_importacao %}
                        {{ ultima_importacao.data_importacao|date:"d/m/Y" }}<br>
                        <span class="text-muted" style="font-size:0.75rem;">{{ ultima_importacao.data_importacao|date:"H:i" }}</span>
                    {% else %}
                        <span class="text-muted">Nenhuma ainda</span>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

</div>

<!-- ═══════════════════════════════════════════════════
     BARRA DE BUSCA
     ═══════════════════════════════════════════════════ -->
<div class="rennova-card mb-3 animate-up" style="animation-delay:0.3s">
    <div class="rennova-card-body py-2">
        <form method="get" class="d-flex align-items-center gap-2 search-bar flex-wrap">
            <div class="input-group" style="max-width:380px;">
                <span class="input-group-text bg-white border-end-0">
                    <i class="bi bi-search text-muted"></i>
                </span>
                <input type="text" name="busca"
                       class="form-control border-start-0 ps-0"
                       placeholder="Buscar por nome ou cargo..."
                       value="{{ busca }}">
                <button class="btn btn-outline-secondary" type="submit">Buscar</button>
                {% if busca %}
                    <a href="{% url 'index' %}" class="btn btn-outline-danger">
                        <i class="bi bi-x-lg"></i>
                    </a>
                {% endif %}
            </div>
            {% if busca %}
                <span class="badge-rennova badge-rennova-primary">
                    {{ total }} resultado{{ total|pluralize }}
                </span>
            {% endif %}
        </form>
    </div>
</div>

<!-- ═══════════════════════════════════════════════════
     TABELA PRINCIPAL
     ═══════════════════════════════════════════════════ -->
<div class="rennova-card animate-up" style="animation-delay:0.38s">
    <div class="rennova-card-header d-flex align-items-center justify-content-between py-2">
        <span class="d-flex align-items-center gap-2">
            <i class="bi bi-table"></i>
            Períodos Aquisitivos
        </span>
        <small class="opacity-75">
            Os meses de férias são salvos automaticamente ao selecionar
        </small>
    </div>

    <div class="rennova-card-body p-0">
        <div class="table-responsive">
            <table class="table table-bordered table-ferias mb-0">
                <thead>
                    <tr>
                        <th>Código</th>
                        <th>Colaborador</th>
                        <th>Cargo</th>
                        <th>Início Aquisit.</th>
                        <th>Fim Aquisit.</th>
                        <th>Limite Ideal</th>
                        <th>Limite Máximo</th>
                        <th class="text-center">Dir.</th>
                        <th class="text-center">Gozo</th>
                        <th class="text-center">Rest.</th>
                        <th>Mês das Férias</th>
                        <th class="text-center">Status</th>
                        <th>Obs.</th>
                    </tr>
                </thead>
                <tbody>
                    {% for colaborador in colaboradores %}
                        {% for periodo in colaborador.periodos.all %}
                            {% with badge=periodo.status_badge %}
                            <tr class="{% if periodo.status_limite == 'danger' %}tr-danger{% elif periodo.status_limite == 'warning' %}tr-warning{% endif %}">

                                {% if forloop.first %}
                                    <td rowspan="{{ colaborador.periodos.count }}"
                                        class="fw-semibold text-muted"
                                        style="font-size:0.78rem;">{{ colaborador.codigo }}</td>
                                    <td rowspan="{{ colaborador.periodos.count }}" class="fw-semibold">
                                        {{ colaborador.nome }}
                                    </td>
                                    <td rowspan="{{ colaborador.periodos.count }}"
                                        class="text-muted" style="font-size:0.78rem;">{{ colaborador.cargo }}</td>
                                {% endif %}

                                <td>{{ periodo.inicio_aquisitivo|date:"d/m/Y" }}</td>
                                <td>{{ periodo.fim_aquisitivo|date:"d/m/Y" }}</td>

                                <td class="{% if periodo.limite_ideal %}text-muted{% else %}text-muted{% endif %}">
                                    {% if periodo.limite_ideal %}
                                        {{ periodo.limite_ideal|date:"d/m/Y" }}
                                    {% else %}—{% endif %}
                                </td>

                                <td class="fw-semibold">
                                    {% if periodo.limite_maximo %}
                                        <span class="{% if periodo.status_limite == 'danger' %}text-danger{% endif %}">
                                            {{ periodo.limite_maximo|date:"d/m/Y" }}
                                        </span>
                                    {% else %}—{% endif %}
                                </td>

                                <td class="text-center">{{ periodo.dias_direito }}</td>
                                <td class="text-center">{{ periodo.dias_gozo }}</td>
                                <td class="text-center">
                                    <span class="fw-semibold {% if periodo.dias_restantes > 0 %}text-primary{% endif %}">
                                        {{ periodo.dias_restantes }}
                                    </span>
                                </td>

                                <!-- Seletor de mês -->
                                <td>
                                    <div class="d-flex align-items-center gap-1">
                                        <input type="month"
                                               class="input-mes"
                                               data-periodo-id="{{ periodo.id }}"
                                               value="{{ periodo.mes_ferias|default:'' }}"
                                               title="Clique para definir o mês das férias">
                                        <span class="badge bg-success badge-salvo"
                                              id="salvo-{{ periodo.id }}">✓</span>
                                    </div>
                                </td>

                                <!-- Badge de status -->
                                <td class="text-center">
                                    <span class="badge {{ badge.0 }}" style="font-size:0.72rem;">
                                        {{ badge.1 }}
                                    </span>
                                </td>

                                <!-- Observação -->
                                <td>
                                    <input type="text"
                                           class="input-mes input-obs"
                                           data-periodo-id="{{ periodo.id }}"
                                           value="{{ periodo.observacao }}"
                                           placeholder="Obs..."
                                           title="Observação">
                                </td>

                            </tr>
                            {% endwith %}
                        {% empty %}
                            <tr>
                                <td>{{ colaborador.codigo }}</td>
                                <td class="fw-semibold">{{ colaborador.nome }}</td>
                                <td>{{ colaborador.cargo }}</td>
                                <td colspan="10" class="text-muted text-center">Sem períodos aquisitivos</td>
                            </tr>
                        {% endfor %}
                    {% empty %}
                        <tr>
                            <td colspan="13">
                                <div class="empty-state">
                                    <i class="bi bi-inbox"></i>
                                    <p class="mb-2 fw-semibold">Nenhum colaborador encontrado</p>
                                    <a href="{% url 'importar' %}" class="btn-rennova-primary btn-rennova-sm">
                                        <i class="bi bi-cloud-upload me-1"></i> Importar provisão do ERP
                                    </a>
                                </div>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Legenda de status -->
<div class="d-flex gap-3 flex-wrap mt-2" style="font-size:0.78rem;color:var(--text-muted);">
    <span><span class="badge bg-danger">⚠ URGENTE</span> — passou do limite máximo</span>
    <span><span class="badge bg-warning text-dark">⏰ Atenção</span> — limite ideal ≤ 60 dias</span>
    <span><span class="badge bg-success">✓ OK</span> — dentro do prazo</span>
</div>

{% endblock %}


{% block extra_js %}
<script>
// ─────────────────────────────────────────────────────────────────
// Salva mês de férias via AJAX ao mudar o input[type=month]
// ─────────────────────────────────────────────────────────────────
document.querySelectorAll('input[type=month]').forEach(input => {
    input.addEventListener('change', function () {
        const periodoId = this.dataset.periodoId;
        const mesFrias  = this.value;

        fetch("{% url 'salvar_mes_ferias' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken'),
            },
            body: JSON.stringify({ periodo_id: periodoId, mes_ferias: mesFrias }),
        })
        .then(r => r.json())
        .then(data => {
            if (data.ok) {
                const badge = document.getElementById('salvo-' + periodoId);
                badge.classList.add('show');
                // Pisca levemente a linha para feedback visual
                const row = this.closest('tr');
                row.style.transition = 'background-color 0.3s';
                row.style.backgroundColor = '#e8f5e9';
                setTimeout(() => {
                    badge.classList.remove('show');
                    row.style.backgroundColor = '';
                }, 2000);
            } else {
                alert('Erro ao salvar: ' + data.erro);
            }
        })
        .catch(() => alert('Erro de conexão ao salvar.'));
    });
});

// ─────────────────────────────────────────────────────────────────
// Salva observação ao perder o foco (só se mudou)
// ─────────────────────────────────────────────────────────────────
document.querySelectorAll('.input-obs').forEach(input => {
    input.dataset.original = input.value;

    input.addEventListener('blur', function () {
        if (this.value === this.dataset.original) return;

        const periodoId = this.dataset.periodoId;
        fetch("{% url 'salvar_observacao' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken'),
            },
            body: JSON.stringify({ periodo_id: periodoId, observacao: this.value }),
        })
        .then(r => r.json())
        .then(data => {
            if (data.ok) {
                this.dataset.original = this.value;
                // Pulso sutil de confirmação
                this.style.borderColor = '#28a745';
                setTimeout(() => { this.style.borderColor = ''; }, 1500);
            }
        });
    });
});

// Lê cookie CSRF do Django
function getCookie(name) {
    const v = document.cookie.match('(^|;) ?' + name + '=([^;]*)(;|$)');
    return v ? v[2] : null;
}
</script>
{% endblock %}
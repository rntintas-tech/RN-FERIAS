{% extends 'provisao/base.html' %}
{% load provisao_extras %}

{% block title %}Tabela de Provisão{% endblock %}

{% block extra_css %}
<style>
    .badge-parcela {
        display: inline-block;
        background: var(--primary-color);
        color: white;
        font-size: 0.73rem;
        font-weight: 500;
        padding: 2px 7px;
        border-radius: var(--border-radius-pill);
        margin: 1px 2px;
        white-space: nowrap;
    }

    .btn-editar-ferias {
        background: transparent;
        border: 1px solid var(--primary-color);
        color: var(--primary-color);
        padding: 1px 7px;
        font-size: 0.72rem;
        border-radius: var(--border-radius-md);
        flex-shrink: 0;
        transition: all 0.2s ease;
    }
    .btn-editar-ferias:hover {
        background: var(--primary-color);
        color: white;
    }

    /*
      width:1% + white-space:nowrap = coluna ajusta ao maior conteúdo.
      Só "Férias Agendadas" e "Status" ficam sem essa classe para expandir.
    */
    .col-compacta {
        width: 1%;
        white-space: nowrap;
    }

    
/* ── Painel de filtros ── */
.filtros-panel {
    border-radius: var(--border-radius-lg);
    overflow: hidden;
    box-shadow: var(--box-shadow-sm);
    margin-bottom: 1rem;
}

/* Cabeçalho com gradiente — igual ao rennova-card-header */
.filtros-header {
    background: var(--secondary-gradient);
    padding: 0.65rem 1.25rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
}

.filtros-header-title {
    color: #fff;
    font-size: 0.78rem;
    font-weight: 600;
    letter-spacing: 0.07em;
    text-transform: uppercase;
    display: flex;
    align-items: center;
    gap: 6px;
    opacity: 0.92;
}

/* Corpo dos filtros com fundo levemente cinza — contraste sutil */
.filtros-body {
    background: #f0f4f8;
    padding: 1rem 1.25rem;
    border-left: 1px solid var(--border-color);
    border-right: 1px solid var(--border-color);
    border-bottom: 1px solid var(--border-color);
    border-radius: 0 0 var(--border-radius-lg) var(--border-radius-lg);
}

/* Campo individual: label pequeno + input */
.filtro-grupo {
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.filtro-label {
    font-size: 0.7rem;
    font-weight: 700;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.06em;
}

.filtro-input {
    height: 36px;
    border: 1.5px solid var(--border-color);
    border-radius: 8px;
    background: #fff;
    font-size: 0.85rem;
    padding: 0 12px;
    color: var(--text-color);
    transition: border-color 0.2s, box-shadow 0.2s;
    width: 100%;
}

.filtro-input:focus {
    outline: none;
    border-color: var(--secondary-color);
    box-shadow: 0 0 0 3px rgba(var(--secondary-color-rgb), 0.15);
}

/* Separador vertical entre grupos */
.filtro-divider {
    width: 1px;
    background: var(--border-color);
    align-self: stretch;
    margin: 0 4px;
    flex-shrink: 0;
}

/* Pills de status — destaque máximo */
.status-chips {
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.status-chip {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 600;
    border: 2px solid;
    text-decoration: none;
    transition: all 0.18s ease;
    white-space: nowrap;
    cursor: pointer;
}

.status-chip .chip-dot {
    width: 7px;
    height: 7px;
    border-radius: 50%;
    flex-shrink: 0;
}

/* Urgente */
.chip-danger              { color: var(--danger-color);  border-color: rgba(220,53,69,0.4);  background: rgba(220,53,69,0.06); }
.chip-danger:hover        { color: #fff; border-color: var(--danger-color); background: var(--danger-color); }
.chip-danger.chip-ativo   { color: #fff; border-color: var(--danger-color); background: var(--danger-color); }
.chip-danger .chip-dot    { background: var(--danger-color); }
.chip-danger.chip-ativo .chip-dot { background: #fff; }

/* Atenção */
.chip-warning              { color: #7d5a00; border-color: rgba(255,193,7,0.5);  background: rgba(255,193,7,0.08); }
.chip-warning:hover        { color: #1a1a1a; border-color: var(--warning-color); background: var(--warning-color); }
.chip-warning.chip-ativo   { color: #1a1a1a; border-color: var(--warning-color); background: var(--warning-color); }
.chip-warning .chip-dot    { background: var(--warning-color); }

/* OK */
.chip-ok              { color: var(--success-color); border-color: rgba(40,167,69,0.4);  background: rgba(40,167,69,0.06); }
.chip-ok:hover        { color: #fff; border-color: var(--success-color); background: var(--success-color); }
.chip-ok.chip-ativo   { color: #fff; border-color: var(--success-color); background: var(--success-color); }
.chip-ok .chip-dot    { background: var(--success-color); }
.chip-ok.chip-ativo .chip-dot { background: #fff; }



/* Card com estado de alerta — borda vermelha no lugar da azul info */
.stat-card-alerta {
    border-color: var(--danger-color) !important;
    background: rgba(220, 53, 69, 0.03);
}

/* Flag vermelha que pisca */
.stat-flag-alerta {
    color: var(--danger-color);
    font-size: 0.85rem;
    animation: pisca 1.2s ease-in-out infinite;
}

/* Texto de aviso piscando */
.stat-aviso-pisca {
    font-size: 0.72rem;
    font-weight: 700;
    color: var(--danger-color);
    text-transform: uppercase;
    letter-spacing: 0.04em;
    animation: pisca 1.2s ease-in-out infinite;
}

/* Pisca: vai de opacidade 1 → 0.2 → 1, mais suave que display:none */
@keyframes pisca {
    0%,  100% { opacity: 1;   }
    50%        { opacity: 0.2; }
}

</style>
{% endblock %}


{% block page_header %}
<div class="rennova-page-header">
    <div class="container-fluid px-4">
        <h2 class="page-title">
            <i class="bi bi-calendar-check me-2"></i>Provisão de Férias
        </h2>
        <p class="text-white mt-1 mb-0">
            Gerencie os agendamentos de férias dos colaboradores da RN Tintas
        </p>
    </div>
</div>
{% endblock %}


{% block content %}

<!-- ═══ STAT CARDS ═══ -->
<div class="row g-3 mb-4">

    <div class="col-6 col-md-3 animate-up">
        <div class="rennova-card stat-card total h-100 mb-0">
            <div class="rennova-card-body py-3">
                <div class="stat-label">Total colaboradores</div>
                <div class="stat-number text-primary">{{ total }}</div>
            </div>
        </div>
    </div>

    <div class="col-6 col-md-3 animate-up">
        <div class="rennova-card stat-card danger h-100 mb-0">
            <div class="rennova-card-body py-3">
                <div class="stat-label">⚠ Urgente</div>
                <div class="stat-number text-danger">{{ urgentes }}</div>
            </div>
        </div>
    </div>

    <div class="col-6 col-md-3 animate-up">
        <div class="rennova-card stat-card warning h-100 mb-0">
            <div class="rennova-card-body py-3">
                <div class="stat-label">⏰ Atenção</div>
                <div class="stat-number" style="color:var(--warning-color);">{{ atencao }}</div>
            </div>
        </div>
    </div>

    <div class="col-6 col-md-3 animate-up">
        <div class="rennova-card stat-card h-100 mb-0
                    {% if importacao_desatualizada %}stat-card-alerta{% else %}info{% endif %}">
            <div class="rennova-card-body py-3">

                <div class="stat-label d-flex align-items-center justify-content-between">
                    <span>Última importação</span>
                    {% if importacao_desatualizada %}
                        <!-- Flag vermelha piscando: chama atenção sem ser invasiva -->
                        <span class="stat-flag-alerta" title="Importação desatualizada">
                            <i class="bi bi-flag-fill"></i>
                        </span>
                    {% endif %}
                </div>

                {% if ultima_importacao %}
                    <div style="font-size:0.85rem; color:var(--info-color); margin-top:4px;">
                        {{ ultima_importacao.data_importacao|date:"d/m/Y" }}<br>
                        <span class="text-muted" style="font-size:0.75rem;">
                            {{ ultima_importacao.data_importacao|date:"H:i" }}
                        </span>
                    </div>

                    <!-- Aviso piscando — só aparece quando desatualizado -->
                    {% if importacao_desatualizada %}
                        <div class="stat-aviso-pisca mt-2">
                            <i class="bi bi-exclamation-circle-fill me-1"></i>
                            Atualize a provisão
                        </div>
                    {% endif %}

                {% else %}
                    <span class="text-muted" style="font-size:0.85rem;">Nenhuma ainda</span>
                {% endif %}

            </div>
        </div>
    </div>

</div>


<!-- ═══ PAINEL DE FILTROS ═══ -->
<div class="filtros-panel animate-up" style="animation-delay:0.3s">

    <!-- Header gradiente — mesmo padrão dos cards do sistema -->
    <div class="filtros-header">
        <span class="filtros-header-title">
            <i class="bi bi-funnel-fill"></i> Filtros
        </span>

        <!-- Resultado + limpar: aparece só quando há filtro ativo -->
        {% if busca or filtro_empresa or filtro_cargo or filtro_status %}
            <div class="d-flex align-items-center gap-2">
                <span style="color:rgba(255,255,255,0.85); font-size:0.78rem;">
                    <i class="bi bi-check-circle-fill me-1" style="color:#00d2ff;"></i>
                    {{ total }} resultado{{ total|pluralize }}
                </span>
                <a href="{% url 'index' %}"
                   style="background:rgba(255,255,255,0.15); border:1px solid rgba(255,255,255,0.3);
                          color:#fff; font-size:0.72rem; padding:3px 10px; border-radius:20px;
                          text-decoration:none; display:inline-flex; align-items:center; gap:4px;
                          transition:background 0.2s;"
                   onmouseover="this.style.background='rgba(255,255,255,0.25)'"
                   onmouseout="this.style.background='rgba(255,255,255,0.15)'">
                    <i class="bi bi-x-lg"></i> Limpar
                </a>
            </div>
        {% endif %}
    </div>

    <!-- Corpo: campos alinhados + botão à direita -->
    <div class="filtros-body">
        <form method="get">
            <div class="d-flex align-items-end gap-3 flex-wrap">

                <!-- Busca por nome / cargo -->
                <div class="filtro-grupo flex-grow-1" style="min-width:200px; max-width:300px;">
                    <label class="filtro-label" for="f-busca">
                        <i class="bi bi-search me-1"></i>Nome ou cargo
                    </label>
                    <div style="position:relative;">
                        <input type="text" name="busca" id="f-busca"
                               class="filtro-input"
                               placeholder="Pesquisar..."
                               value="{{ busca }}"
                               style="padding-left:32px;">
                        <i class="bi bi-search"
                           style="position:absolute; left:10px; top:50%; transform:translateY(-50%);
                                  font-size:0.8rem; color:var(--text-muted); pointer-events:none;"></i>
                    </div>
                </div>

                <div class="filtro-divider d-none d-md-block"></div>

                <!-- Empresa -->
                <div class="filtro-grupo" style="min-width:160px; max-width:220px;">
                    <label class="filtro-label" for="f-empresa">
                        <i class="bi bi-building me-1"></i>Empresa
                    </label>
                    <select name="empresa" id="f-empresa" class="filtro-input">
                        <option value="">Todas</option>
                        {% for emp in todas_empresas %}
                            <option value="{{ emp }}" {% if filtro_empresa == emp %}selected{% endif %}>{{ emp }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Cargo -->
                <div class="filtro-grupo" style="min-width:160px; max-width:220px;">
                    <label class="filtro-label" for="f-cargo">
                        <i class="bi bi-person-badge me-1"></i>Cargo
                    </label>
                    <select name="cargo" id="f-cargo" class="filtro-input">
                        <option value="">Todos</option>
                        {% for cargo in todos_cargos %}
                            <option value="{{ cargo }}" {% if filtro_cargo == cargo %}selected{% endif %}>{{ cargo }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="filtro-divider d-none d-md-block"></div>

                <!-- Status: chips clicáveis — sem submit, aplicam direto -->
                <div class="filtro-grupo">
                    <label class="filtro-label"><i class="bi bi-flag me-1"></i>Status</label>
                    <div class="d-flex gap-2 flex-wrap align-items-center" style="height:36px;">
                        <a href="?busca={{ busca }}&empresa={{ filtro_empresa }}&cargo={{ filtro_cargo }}&status={% if filtro_status == 'danger' %}{% else %}danger{% endif %}"
                           class="status-chip chip-danger {% if filtro_status == 'danger' %}chip-ativo{% endif %}">
                            <span class="chip-dot"></span> Urgente
                        </a>
                        <a href="?busca={{ busca }}&empresa={{ filtro_empresa }}&cargo={{ filtro_cargo }}&status={% if filtro_status == 'warning' %}{% else %}warning{% endif %}"
                           class="status-chip chip-warning {% if filtro_status == 'warning' %}chip-ativo{% endif %}">
                            <span class="chip-dot"></span> Atenção
                        </a>
                        <a href="?busca={{ busca }}&empresa={{ filtro_empresa }}&cargo={{ filtro_cargo }}&status={% if filtro_status == 'ok' %}{% else %}ok{% endif %}"
                           class="status-chip chip-ok {% if filtro_status == 'ok' %}chip-ativo{% endif %}">
                            <span class="chip-dot"></span> OK
                        </a>
                    </div>
                    <input type="hidden" name="status" value="{{ filtro_status }}">
                </div>

                <!-- Botão aplicar — empurrado para a direita -->
                <div class="ms-auto flex-shrink-0">
                    <button class="btn-rennova-primary btn-rennova-sm" type="submit"
                            style="height:36px; padding:0 18px;">
                        <i class="bi bi-search me-1"></i> Aplicar
                    </button>
                </div>

            </div>
        </form>
    </div>

</div>

<!-- ═══ TABELA PRINCIPAL ═══ -->
<div class="rennova-card animate-up" style="animation-delay:0.38s">

    <div class="rennova-card-header py-2">
        <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
            <span class="d-flex align-items-center gap-2 fw-semibold">
                <i class="bi bi-table"></i>
                Períodos Aquisitivos
            </span>
            <small class="opacity-75">
                Clique em <i class="bi bi-pencil-fill"></i> para agendar férias
            </small>
        </div>

         <!-- Legenda: status de prazo + cores dos badges de férias -->
        <div class="d-flex gap-3 flex-wrap mt-2" style="font-size:0.77rem; color:rgba(255,255,255,0.85);">

            <!-- Status de prazo do limite máximo -->
            <span class="d-flex align-items-center gap-1">
                <span class="badge bg-danger" style="font-size:0.68rem;">⚠ URGENTE</span>
                &lt; 60 dias p/ limite máx.
            </span>
            <span class="d-flex align-items-center gap-1">
                <span class="badge bg-warning text-dark" style="font-size:0.68rem;">⏰ ATENÇÃO</span>
                &lt; 90 dias p/ limite máx.
            </span>
            <span class="d-flex align-items-center gap-1">
                <span class="badge bg-success" style="font-size:0.68rem;">✔ OK</span>
                dentro do prazo
            </span>

            <!-- Separador visual -->
            <span style="opacity:0.4;">|</span>

            <!-- Significado das cores dos badges de férias agendadas -->
            <span class="d-flex align-items-center gap-1">
                <span class="badge-parcela" style="font-size:0.68rem; padding:2px 7px;">Mês/Ano</span>
                futuro
            </span>
            <span class="d-flex align-items-center gap-1">
                <span class="badge-parcela badge-parcela-atual" style="font-size:0.68rem; padding:2px 7px;">Mês/Ano</span>
                este mês
            </span>
            <span class="d-flex align-items-center gap-1">
                <span class="badge-parcela badge-parcela-passada" style="font-size:0.68rem; padding:2px 7px;">Mês/Ano</span>
                realizado
            </span>

        </div>
    </div>

    <div class="table-responsive">
        <table class="table table-ferias mb-0">
            <thead>
                <tr>
                    <th class="col-compacta">Cód.</th>
                    <th class="col-compacta">Nome</th>
                    <th class="col-compacta">Empresa</th>
                    <th class="col-compacta">Admissão</th>
                    <th class="col-compacta">Cargo</th>
                    <th class="col-compacta">Período Aquisitivo</th>
                    <th class="col-compacta">Limite Ideal</th>
                    <th class="col-compacta">Limite Máx.</th>
                    <th class="col-compacta text-center">Direito</th>
                    <th class="col-compacta text-center">Gozo</th>
                    <th class="col-compacta text-center">Restante</th>
                    <th>Férias Agendadas</th>
                    <th class="col-compacta text-center">Status</th>
                </tr>
            </thead>
            <tbody>

                {% for colaborador in colaboradores %}
                    {% for periodo in colaborador.periodos.all %}
                        {% with badge=periodo.status_badge %}
                        <tr id="tr-{{ periodo.id }}"
                            class="{% if periodo.status_limite == 'danger' %}tr-danger{% elif periodo.status_limite == 'warning' %}tr-warning{% endif %}">

                            {% if forloop.first %}
                                <td rowspan="{{ colaborador.periodos.count }}"
                                    class="col-compacta fw-semibold text-muted"
                                    style="font-size:0.78rem;">
                                    {{ colaborador.codigo }}
                                </td>
                                <td rowspan="{{ colaborador.periodos.count }}"
                                    class="col-compacta fw-semibold">
                                    {{ colaborador.nome }}
                                </td>
                                <td rowspan="{{ colaborador.periodos.count }}"
                                    class="col-compacta text-muted"
                                    style="font-size:0.78rem;">
                                    {{ colaborador.empresa }}
                                </td>
                                <td rowspan="{{ colaborador.periodos.count }}"
                                    class="col-compacta text-muted"
                                    style="font-size:0.78rem;">
                                    {{ colaborador.data_admissao|date:"d/m/Y"|default:"—" }}
                                </td>
                                <td rowspan="{{ colaborador.periodos.count }}"
                                    class="col-compacta text-muted"
                                    style="font-size:0.78rem;">
                                    {{ colaborador.cargo }}
                                </td>
                            {% endif %}

                            <td class="col-compacta">{{ periodo.inicio_aquisitivo|date:"d/m/Y" }}</td>
                            <td class="col-compacta">{{ periodo.limite_ideal|date:"d/m/Y"|default:"—" }}</td>
                            <td class="col-compacta {% if periodo.status_limite == 'warning' or periodo.status_limite == 'danger' %}text-danger fw-semibold{% endif %}">
                                {{ periodo.limite_maximo|date:"d/m/Y"|default:"—" }}
                            </td>
                            <td class="col-compacta text-center">{{ periodo.dias_direito|floatformat:0 }}</td>
                            <td class="col-compacta text-center">{{ periodo.dias_gozo|floatformat:0 }}</td>
                            <td class="col-compacta text-center">{{ periodo.dias_restantes|floatformat:0 }}</td>

                            <td id="cell-ferias-{{ periodo.id }}"
                                data-periodo-id="{{ periodo.id }}"
                                data-nome="{{ colaborador.nome }}"
                                data-periodo-label="{{ periodo.inicio_aquisitivo|date:'d/m/Y' }} → {{ periodo.fim_aquisitivo|date:'d/m/Y' }}"
                                data-dias-direito="{{ periodo.dias_direito|floatformat:0 }}"
                                data-parcelas='{{ periodo.parcelas.all|jsonparcelas }}'>

                                <div class="d-flex align-items-center gap-2 flex-wrap">
                                    <span id="resumo-{{ periodo.id }}">
                                        {% now "Y-m" as mes_atual %}
                                        {% for parcela in periodo.parcelas.all %}
                                            <span class="badge-parcela
                                                {% if parcela.mes_ferias < mes_atual %}badge-parcela-passada
                                                {% elif parcela.mes_ferias == mes_atual %}badge-parcela-atual
                                                {% endif %}">
                                                {{ parcela.mes_ferias_display }}{% if parcela.dias %} ({{ parcela.dias|floatformat:0 }}d){% endif %}
                                            </span>
                                        {% empty %}
                                            <span class="text-muted" style="font-size:0.78rem;">—</span>
                                        {% endfor %}
                                    </span>
                                    <button class="btn btn-editar-ferias btn-sm"
                                            onclick="abrirModal({{ periodo.id }})">
                                        <i class="bi bi-pencil-fill"></i>
                                    </button>
                                </div>
                            </td>

                            <td class="col-compacta text-center">
                                <span id="status-badge-{{ periodo.id }}"
                                      class="badge {{ badge.0 }}"
                                      style="font-size:0.72rem;">
                                    {{ badge.1 }}
                                </span>
                            </td>

                        </tr>
                        {% endwith %}

                    {% empty %}
                        <tr>
                            <td class="col-compacta">{{ colaborador.codigo }}</td>
                            <td class="col-compacta fw-semibold">{{ colaborador.nome }}</td>
                            <td class="col-compacta">{{ colaborador.empresa }}</td>
                            <td class="col-compacta">{{ colaborador.data_admissao|date:"d/m/Y"|default:"—" }}</td>
                            <td class="col-compacta">{{ colaborador.cargo }}</td>
                            <td colspan="8" class="text-muted text-center">Sem períodos aquisitivos</td>
                        </tr>
                    {% endfor %}

                {% empty %}
                    <tr>
                        <td colspan="13">
                            <div class="empty-state">
                                <i class="bi bi-inbox"></i>
                                <p class="mb-2 fw-semibold">Nenhum colaborador encontrado</p>
                                <a href="{% url 'importar' %}" class="btn-rennova-primary btn-rennova-sm">
                                    <i class="bi bi-cloud-upload me-1"></i> Importar provisão do ERP
                                </a>
                            </div>
                        </td>
                    </tr>
                {% endfor %}

            </tbody>
        </table>
    </div>
</div>


<!-- ═══ MODAL DE FÉRIAS ═══ -->
<div class="modal fade" id="modalFerias" tabindex="-1"
     aria-labelledby="modalFeriasLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="border-radius:var(--border-radius-lg);border:none;">

            <div class="modal-header"
                 style="background:var(--primary-gradient);color:white;
                        border-radius:var(--border-radius-lg) var(--border-radius-lg) 0 0;">
                <div>
                    <h5 class="modal-title fw-bold mb-0" id="modalFeriasLabel">
                        <i class="bi bi-calendar2-check me-2"></i>Férias Agendadas
                    </h5>
                    <small id="modal-subtitulo" class="opacity-75"></small>
                </div>
                <button type="button" class="btn-close btn-close-white"
                        data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body px-4 pt-3 pb-2">

                <div id="barra-dias" class="mb-3" style="display:none;">
                    <div class="d-flex justify-content-between mb-1"
                         style="font-size:0.78rem;color:var(--text-muted);">
                        <span>Dias agendados</span>
                        <span id="label-dias"></span>
                    </div>
                    <div class="progress" style="height:8px;border-radius:var(--border-radius-pill);">
                        <div id="barra-prog" class="progress-bar" role="progressbar"
                             style="width:0%;background:var(--primary-gradient);"></div>
                    </div>
                </div>

                <div id="lista-parcelas"></div>

                <hr class="my-3">

                <p class="fw-semibold mb-2"
                   style="font-size:0.85rem;color:var(--text-muted);
                          text-transform:uppercase;letter-spacing:0.5px;">
                    Adicionar parcela
                </p>
                <div class="row g-2 align-items-end">
                    <div class="col-5">
                        <label class="form-label mb-1" style="font-size:0.78rem;">Mês</label>
                        <input type="month" id="nova-mes" class="form-control form-control-sm">
                    </div>
                    <div class="col-3">
                        <label class="form-label mb-1" style="font-size:0.78rem;">
                            Dias <span class="text-muted">(opc.)</span>
                        </label>
                        <input type="number" id="nova-dias" class="form-control form-control-sm"
                               placeholder="ex: 15" min="1" max="30" step="0.5">
                    </div>
                    <div class="col-4">
                        <label class="form-label mb-1" style="font-size:0.78rem;">
                            Obs. <span class="text-muted">(opc.)</span>
                        </label>
                        <input type="text" id="nova-obs" class="form-control form-control-sm"
                               placeholder="Nota...">
                    </div>
                    <div class="col-12">
                        <button class="btn btn-sm w-100 mt-1"
                                style="background:var(--primary-gradient);color:white;
                                       border:none;border-radius:var(--border-radius-md);"
                                onclick="adicionarParcela()">
                            <i class="bi bi-plus-circle me-1"></i> Adicionar
                        </button>
                        <div id="erro-modal" class="text-danger mt-1"
                             style="font-size:0.8rem;display:none;"></div>
                    </div>
                </div>

            </div>

            <div class="modal-footer border-0 pt-0">
                <button type="button" class="btn btn-outline-secondary btn-sm"
                        data-bs-dismiss="modal">Fechar</button>
            </div>

        </div>
    </div>
</div>

{% endblock %}


{% block extra_js %}
<script>
let periodoAtivo = null;
const modalBS   = new bootstrap.Modal(document.getElementById('modalFerias'));

function getCookie(name) {
    const val   = `; ${document.cookie}`;
    const parts = val.split(`; ${name}=`);
    return parts.length === 2 ? parts.pop().split(';').shift() : '';
}

function abrirModal(periodoId) {
    const cell   = document.getElementById('cell-ferias-' + periodoId);
    periodoAtivo = periodoId;

    document.getElementById('modal-subtitulo').textContent =
        cell.dataset.nome + ' · ' + cell.dataset.periodoLabel;

    let parcelas = [];
    try { parcelas = JSON.parse(cell.dataset.parcelas || '[]'); } catch(e) {}

    renderizarParcelas(parcelas);
    atualizarBarra(parcelas, parseFloat(cell.dataset.diasDireito || 0));

    document.getElementById('nova-mes').value  = '';
    document.getElementById('nova-dias').value = '';
    document.getElementById('nova-obs').value  = '';
    document.getElementById('erro-modal').style.display = 'none';

    modalBS.show();
}

function renderizarParcelas(parcelas) {
    const container = document.getElementById('lista-parcelas');

    if (!parcelas.length) {
        container.innerHTML = `<p class="text-muted text-center py-2" style="font-size:0.85rem;">
            <i class="bi bi-calendar-x me-1"></i>Nenhuma férias agendada ainda.
        </p>`;
        return;
    }

    container.innerHTML = parcelas.map(p => `
        <div class="d-flex align-items-center justify-content-between py-1 px-2 border-bottom"
             style="font-size:0.85rem;">
            <div class="d-flex align-items-center gap-2">
                <span class="badge-parcela">${p.mes_ferias_display}</span>
                ${p.dias       ? `<span class="text-muted">${p.dias}d</span>` : ''}
                ${p.observacao ? `<span class="text-muted fst-italic">${p.observacao}</span>` : ''}
            </div>
            <button class="btn btn-sm btn-outline-danger"
                    style="padding:1px 8px;font-size:0.75rem;"
                    onclick="deletarParcela(${p.id})">
                <i class="bi bi-trash"></i>
            </button>
        </div>
    `).join('');
}

function atualizarBarra(parcelas, diasDireito, diasUsados) {
    const barra = document.getElementById('barra-dias');
    if (!diasDireito) { barra.style.display = 'none'; return; }

    const usados = (diasUsados !== undefined)
        ? diasUsados
        : parcelas.reduce((acc, p) => acc + (p.dias ? parseFloat(p.dias) : 0), 0);

    const pct  = Math.min(100, Math.round((usados / diasDireito) * 100));
    const prog = document.getElementById('barra-prog');
    prog.style.width      = pct + '%';
    prog.className        = 'progress-bar' + (pct >= 100 ? ' bg-danger' : pct >= 80 ? ' bg-warning' : '');
    prog.style.background = pct < 80 ? 'var(--primary-gradient)' : '';

    document.getElementById('label-dias').textContent = `${usados}d / ${diasDireito}d`;
    barra.style.display = 'block';
}

function atualizarUI(periodoId, data) {
    const { parcelas, dias_usados, dias_direito, status_badge, status_limite } = data;
    const cell     = document.getElementById('cell-ferias-' + periodoId);
    const mesAtual = new Date().toISOString().slice(0, 7);

    renderizarParcelas(parcelas);
    atualizarBarra(parcelas, dias_direito, dias_usados);
    cell.dataset.parcelas = JSON.stringify(parcelas);

    const resumo = document.getElementById('resumo-' + periodoId);
    resumo.innerHTML = parcelas.length
        ? parcelas.map(p => {
            let cls = 'badge-parcela';
            if      (p.mes_ferias < mesAtual)  cls += ' badge-parcela-passada';
            else if (p.mes_ferias === mesAtual) cls += ' badge-parcela-atual';
            const dias = p.dias ? ` (${parseFloat(p.dias)}d)` : '';
            return `<span class="${cls}">${p.mes_ferias_display}${dias}</span>`;
          }).join('')
        : `<span class="text-muted" style="font-size:0.78rem;">—</span>`;

    if (status_badge) {
        const el = document.getElementById('status-badge-' + periodoId);
        if (el) {
            el.className      = `badge ${status_badge[0]}`;
            el.style.fontSize = '0.72rem';
            el.textContent    = status_badge[1];
        }
    }

    if (status_limite !== undefined) {
        const tr = document.getElementById('tr-' + periodoId);
        if (tr) {
            tr.classList.remove('tr-danger', 'tr-warning');
            if      (status_limite === 'danger')  tr.classList.add('tr-danger');
            else if (status_limite === 'warning') tr.classList.add('tr-warning');
        }
    }
}

function adicionarParcela() {
    const mes    = document.getElementById('nova-mes').value;
    const dias   = document.getElementById('nova-dias').value;
    const obs    = document.getElementById('nova-obs').value;
    const erroEl = document.getElementById('erro-modal');

    if (!mes) {
        erroEl.textContent   = 'Informe o mês.';
        erroEl.style.display = 'block';
        return;
    }
    erroEl.style.display = 'none';

    fetch("{% url 'salvar_parcela' %}", {
        method:  'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
        body:    JSON.stringify({ periodo_id: periodoAtivo, mes_ferias: mes, dias, observacao: obs }),
    })
    .then(r => r.json())
    .then(data => {
        if (data.ok) {
            atualizarUI(periodoAtivo, data);
            document.getElementById('nova-mes').value  = '';
            document.getElementById('nova-dias').value = '';
            document.getElementById('nova-obs').value  = '';
            showToast('Férias adicionadas com sucesso!', 'success');
        } else {
            erroEl.textContent   = data.erro || 'Erro ao salvar.';
            erroEl.style.display = 'block';
            showToast(data.erro || 'Erro ao salvar.', 'danger');
        }
    })
    .catch(() => {
        erroEl.textContent   = 'Erro de conexão.';
        erroEl.style.display = 'block';
        showToast('Erro de conexão com o servidor.', 'danger');
    });
}

function deletarParcela(parcelaId) {
    if (!confirm('Remover esta parcela?')) return;

    fetch("{% url 'deletar_parcela' %}", {
        method:  'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
        body:    JSON.stringify({ parcela_id: parcelaId }),
    })
    .then(r => r.json())
    .then(data => {
        if (data.ok) {
            atualizarUI(periodoAtivo, data);
            showToast('Parcela removida.', 'success');
        } else {
            showToast(data.erro || 'Erro ao remover.', 'danger');
        }
    })
    .catch(() => showToast('Erro de conexão com o servidor.', 'danger'));
}

function showToast(msg, tipo) {
    const toast = document.getElementById('liveToast');
    if (!toast) return;
    const body = toast.querySelector('.toast-body');
    if (body) body.textContent = msg;
    toast.classList.remove('bg-success', 'bg-danger', 'bg-warning', 'text-white');
    if (tipo === 'success') toast.classList.add('bg-success', 'text-white');
    if (tipo === 'danger')  toast.classList.add('bg-danger',  'text-white');
    bootstrap.Toast.getOrCreateInstance(toast).show();
}
</script>
{% endblock %}